#!/usr/bin/env python
# coding: utf-8
from Utils import EDITION

# å¤–éƒ¨å‚æ•°è¾“å…¥

import argparse
import sys
import os

ap = argparse.ArgumentParser(description="Export MP4 video from timeline file.")
ap.add_argument("-l", "--TimeLine", help='Timeline (and break_point with same name), which was generated by replay_generator.py.',type=str)
ap.add_argument("-d", "--MediaObjDefine", help='Definition of the media elements, using real python code.',type=str)
ap.add_argument("-t", "--CharacterTable", help='This program do not need CharacterTable.',type=str)
ap.add_argument("-o", "--OutputPath", help='Choose the destination directory to save the project timeline and break_point file.',type=str,default=None)
# å¢åŠ ä¸€ä¸ªï¼Œè¯»å–æ—¶é—´è½´å’Œæ–­ç‚¹æ–‡ä»¶çš„é€‰é¡¹ï¼
ap.add_argument("-F", "--FramePerSecond", help='Set the FPS of display, default is 30 fps, larger than this may cause lag.',type=int,default=30)
ap.add_argument("-W", "--Width", help='Set the resolution of display, default is 1920, larger than this may cause lag.',type=int,default=1920)
ap.add_argument("-H", "--Height", help='Set the resolution of display, default is 1080, larger than this may cause lag.',type=int,default=1080)
ap.add_argument("-Z", "--Zorder", help='Set the display order of layers, not recommended to change the values unless necessary!',type=str,
                default='BG2,BG1,Am3,Am2,Am1,AmS,Bb,BbS')
ap.add_argument("-Q", "--Quality", help='Choose the quality (ffmpeg crf) of output video.',type=int,default=24)
args = ap.parse_args()

Width = args.Width #æ˜¾ç¤ºçš„åˆ†è¾¨ç‡
Height = args.Height
frame_rate = args.FramePerSecond #å¸§ç‡ å•ä½fps
zorder = args.Zorder.split(',') #æ¸²æŸ“å›¾å±‚é¡ºåº

try:
    for path in [args.TimeLine,args.MediaObjDefine]:
        if path is None:
            print(path)
            raise OSError("[31m[ArgumentError]:[0m Missing principal input argument!")
        if os.path.isfile(path) == False:
            raise OSError("[31m[ArgumentError]:[0m Cannot find file "+path)

    if args.OutputPath is None:
        pass 
    elif os.path.isdir(args.OutputPath) == False:
        try:
            os.makedirs(args.OutputPath)
        except Exception:
            raise OSError("[31m[SystemError]:[0m Cannot make directory "+args.OutputPath)
    args.OutputPath = args.OutputPath.replace('\\','/')

    # FPS
    if frame_rate <= 0:
        raise ValueError("[31m[ArgumentError]:[0m "+str(frame_rate))
    elif frame_rate>30:
        print("[33m[warning]:[0m",'FPS is set to '+str(frame_rate)+', which may cause lag in the display!')

    if (Width<=0) | (Height<=0):
        raise ValueError("[31m[ArgumentError]:[0m "+str((Width,Height)))
    if Width*Height > 3e6:
        print("[33m[warning]:[0m",'Resolution is set to more than 3M, which may cause lag in the display!')
except Exception as E:
    print(E)
    sys.exit(1)

import pandas as pd
import numpy as np
import pygame
import ffmpeg
import pydub
import time
import re
import pickle

# è‡ªç”±ç‚¹
from FreePos import Pos,FreePos,PosGrid

# ç±»å®šä¹‰ alpha 1.11.0

from Medias import Text
from Medias import StrokeText
from Medias import Bubble
from Medias import Balloon
from Medias import DynamicBubble
from Medias import ChatWindow
from Medias import Background
from Medias import Animation
from Medias import GroupedAnimation
from Medias import BuiltInAnimation
from Medias import screen_config
screen_config['screen_size'] = (Width,Height)
screen_config['frame_rate'] = frame_rate

from Medias import Audio_Video as Audio
from Medias import BGM_Video as BGM

# å¤„ç†bg å’Œ am çš„parser
def parse_timeline(layer):
    global timeline,break_point
    track = render_timeline[[layer]]
    clips = []
    item,begin,end = 'NA',0,0
    for key,values in track.iterrows():
        #å¦‚æœitemå˜åŒ–äº†ï¼Œæˆ–è€…è¿›å…¥äº†æŒ‡å®šçš„æ–­ç‚¹
        if (values[layer] != item) | (key in break_point.values): 
            if (item == 'NA') | (item!=item): # å¦‚æœitmeæ˜¯ç©º 
                pass # åˆ™ä¸è¾“å‡ºä»€ä¹ˆ
            else:
                end = key #å¦åˆ™æŠŠå½“å‰keyä½œä¸ºä¸€ä¸ªclipçš„æ–­ç‚¹
                clips.append((item,begin,end)) #å¹¶è®°å½•ä¸‹è¿™ä¸ªæ–­ç‚¹
            item = values[layer] #æ— è®ºå¦‚ä½•ï¼Œé‡è®¾itemå’Œbegin
            begin = key
        else: #å¦‚æœä¸æ»¡è¶³æ–­ç‚¹è¦æ±‚ï¼Œé‚£ä¹ˆå°±ä»€ä¹ˆéƒ½ä¸åš
            pass
    # å¾ªç¯ç»“æŸä¹‹åï¼Œæœ€åæ£€å®šä¸€æ¬¡æ˜¯å¦éœ€è¦è¾“å‡ºä¸€ä¸ªclips
    end = key
    if (item == 'NA') | (item!=item):
        pass
    else:
        clips.append((item,begin,end))
    return clips #è¿”å›ä¸€ä¸ªclipçš„åˆ—è¡¨

# æ¸²æŸ“å‡½æ•°
def render(this_frame):
    global media_list
    for layer in zorder:
        # ä¸æ¸²æŸ“çš„æ¡ä»¶ï¼šå›¾å±‚ä¸º"Na"ï¼Œæˆ–è€…np.nan
        if (this_frame[layer]=='NA')|(this_frame[layer]!=this_frame[layer]):
            continue
        elif this_frame[layer+'_a']<=0: #æˆ–è€…å›¾å±‚çš„é€æ˜åº¦å°äºç­‰äº0(ç”±äºfillna("NA"),å‡ºç°çš„å¼‚å¸¸)
            continue
        elif this_frame[layer] not in media_list:
            raise RuntimeError('[31m[RenderError]:[0m Undefined media object : "'+this_frame[layer]+'".')
        elif layer[0:2] == 'BG':
            try:
                exec('{0}.display(surface=screen,alpha={1},adjust={2},center={3})'.format(this_frame[layer],
                                                                                          this_frame[layer+'_a'],
                                                                                          '\"'+this_frame[layer+'_p']+'\"',
                                                                                          '\"'+this_frame[layer+'_c']+'\"'))
            except Exception:
                raise RuntimeError('[31m[RenderError]:[0m Failed to render "'+this_frame[layer]+'" as Background.')
        elif layer[0:2] == 'Am': # å…¼å®¹H_LG1(1)è¿™ç§åŠ¨ç”»å½¢å¼ alpha1.6.3
            try:
                exec('{0}.display(surface=screen,alpha={1},adjust={2},frame={3},center={4})'.format(
                                                                                         this_frame[layer],
                                                                                         this_frame[layer+'_a'],
                                                                                         '\"'+this_frame[layer+'_p']+'\"',
                                                                                         this_frame[layer+'_t'],
                                                                                         '\"'+this_frame[layer+'_c']+'\"'))
            except Exception:
                raise RuntimeError('[31m[RenderError]:[0m Failed to render "'+this_frame[layer]+'" as Animation.')
        elif layer[0:2] == 'Bb':
            try:
                exec('{0}.display(surface=screen,text={2},header={3},alpha={1},adjust={4},center={5})'.format(this_frame[layer],
                                                                                                   this_frame[layer+'_a'],
                                                                                                   '\"'+this_frame[layer+'_main']+'\"',
                                                                                                   '\"'+this_frame[layer+'_header']+'\"',
                                                                                                   '\"'+this_frame[layer+'_p']+'\"',
                                                                                                   '\"'+this_frame[layer+'_c']+'\"'))
            except Exception:
                raise RuntimeError('[31m[RenderError]:[0m Failed to render "'+this_frame[layer]+'" as Bubble.')
    return 1

# è¢«å ç”¨çš„å˜é‡å # 1.7.7
occupied_variable_name = open('./media/occupied_variable_name.list','r',encoding='utf8').read().split('\n')

# Main():

print('[export Video]: Welcome to use exportVideo for TRPG-replay-generator '+EDITION)
print('[export Video]: The output mp4 file will be saved at "'+args.OutputPath+'"')

# è½½å…¥timeline å’Œ breakpoint
timeline_ifile = open(args.TimeLine,'rb')
render_timeline,break_point,bulitin_media = pickle.load(timeline_ifile)
timeline_ifile.close()
stdin_name = args.TimeLine.replace('\\','/').split('/')[-1]

cmap = {'black':(0,0,0,255),'white':(255,255,255,255),'greenscreen':(0,177,64,255)}

# è½½å…¥odæ–‡ä»¶
try:
    object_define_text = open(args.MediaObjDefine,'r',encoding='utf-8').read()#.split('\n')
except UnicodeDecodeError as E:
    print('[31m[DecodeError]:[0m',E)
    sys.exit(1)
if object_define_text[0] == '\ufeff': # 139 debug
    print('[33m[warning]:[0m','UTF8 BOM recognized in MediaDef, it will be drop from the begin of file!')
    object_define_text = object_define_text[1:]
object_define_text = object_define_text.split('\n')

media_list=[]
for i,text in enumerate(object_define_text):
    if text == '':
        continue
    elif text[0] == '#':
        continue
    else:
        try:
            exec(text) #å¯¹è±¡å®ä¾‹åŒ–
            obj_name = text.split('=')[0]
            obj_name = obj_name.replace(' ','')
            if obj_name in occupied_variable_name:
                raise SyntaxError('Obj name occupied')
            elif (len(re.findall('\w+',obj_name))==0)|(obj_name[0].isdigit()):
                raise SyntaxError('Invalid Obj name')
            media_list.append(obj_name) #è®°å½•æ–°å¢å¯¹è±¡åç§°
        except Exception as E:
            print('[31m[SyntaxError]:[0m "'+text+'" appeared in media define file line ' + str(i+1)+' is invalid syntax:',E)
            sys.exit(1)
black = Background('black')
white = Background('white')
media_list.append('black')
media_list.append('white')
# alpha 1.6.5 è½½å…¥å¯¼å‡ºçš„å†…å»ºåª’ä½“
for key,values in bulitin_media.iteritems():
    exec(values)
    media_list.append(key)

# åˆæˆéŸ³è½¨

print('[export Video]: Start mixing audio tracks')

tracks = ['SE','Voice','BGM']
main_Track = pydub.AudioSegment.silent(duration=int(break_point.values.max()/frame_rate*1000),frame_rate=48000) # ä¸»è½¨é“

for tr in tracks:
    this_Track = pydub.AudioSegment.silent(duration=int(break_point.values.max()/frame_rate*1000),frame_rate=48000)
    if tr == 'BGM':
        BGM_clips = parse_timeline('BGM')
        for i,item in enumerate(BGM_clips):
            voice,begin,drop = item
            if voice == 'stop':
                continue # é‡åˆ°stopï¼Œç›´åˆ‡åˆ‡åˆ°ä¸‹ä¸€æ®µ
            elif voice not in media_list: # å¦‚æœæ˜¯è·¯å¾„å½¢å¼
                temp_BGM = BGM(voice[1:-1]) # å»é™¤å¼•å·
                voice = 'temp_BGM'
            try:
                end = BGM_clips[i+1][1]
            except IndexError:
                end = break_point.values.max()
            # print(begin,end)
            # è¿™é‡Œä¼¼ä¹æ˜¯æœ‰ï¼ŒBGMä¸æ­£å¸¸å¾ªç¯çš„bugï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼
            this_Track = this_Track.overlay(
                pydub.AudioSegment.silent(duration=int((end-begin)/frame_rate*1000),frame_rate=48000).overlay(eval(voice+'.media'),loop=eval(voice+'.loop')),
                position = int(begin/frame_rate*1000)
                )
    else:
        for item in parse_timeline(tr):
            voice,begin,drop = item
            if voice not in media_list: # å¦‚æœæ˜¯è·¯å¾„å½¢å¼
                temp_AU = Audio(voice[1:-1]) # å»é™¤å¼•å·
                voice = 'temp_AU'
            this_Track = this_Track.overlay(eval(voice+'.media'),position = int(begin/frame_rate*1000))
    main_Track = main_Track.overlay(this_Track) #åˆæˆåˆ°ä¸»éŸ³è½¨
    print('[export Video]: Track {0} finished.'.format(tr))

main_Track.export(args.OutputPath+'/'+stdin_name+'.mp3',format='mp3',codec='mp3',bitrate='256k')

print('[export Video]: Audio mixing done!')

# åˆå§‹åŒ–

print('[export Video]: Start encoding video, using ffmpeg.')

pygame.init()
screen = pygame.display.set_mode((Width,Height),pygame.HIDDEN)

# è½¬æ¢åª’ä½“å¯¹è±¡
for media in media_list: 
    try:
        exec(media+'.convert()')
    except Exception as E:
        print('[31m[MediaError]:[0m Exception during converting',media,':',E)
        sys.exit(1)

# ffmpegè¾“å‡º
output_engine = (
    ffmpeg
    .input('pipe:',format='rawvideo',r=frame_rate,pix_fmt='rgb24', s='{0}x{1}'.format(Height,Width)) # è§†é¢‘æ¥æº
    .output(ffmpeg.input(args.OutputPath+'/'+stdin_name+'.mp3').audio,
            args.OutputPath+'/'+stdin_name+'.mp4',
            pix_fmt='yuv420p',r=frame_rate,crf=args.Quality,
            **{'loglevel':'quiet','vf':'transpose=0'}) # è¾“å‡º
    .overwrite_output()
    .run_async(pipe_stdin=True)
)

begin_time = time.time()
# ä¸»å¾ªç¯
n=0
while n < break_point.max():
    try:
        if n in render_timeline.index:
            this_frame = render_timeline.loc[n]
            render(this_frame)
            obyte = pygame.surfarray.array3d(screen).tobytes()
        else:
            pass # èŠ‚çº¦ç®—åŠ›
        output_engine.stdin.write(obyte) # å†™å…¥è§†é¢‘
        n = n + 1 #ä¸‹ä¸€å¸§
    except Exception as E:
        print(E)
        print('[31m[RenderError]:[0m','Render exception at frame:',n)
        output_engine.stdin.close()
        pygame.quit()
        sys.exit(1)
    if n%frame_rate == 1:
        finish_rate = n/break_point.values.max()
        print('[export Video]:','[{0}] {1},\t{2}'.format(int(finish_rate*50)*'#'+(50-int(50*finish_rate))*' ',
                                                        '%.1f'%(finish_rate*100)+'%','{0}/{1}'.format(n,'%d'%break_point.values.max())),
        end = "\r"
        )
    elif n == break_point.values.max():
        print('[export Video]:','[{0}] {1},\t{2}'.format(50*'#',
                                                        '%.1f'%100+'%','{0}/{1}'.format(n,n)))
output_engine.stdin.close()
pygame.quit()

used_time = time.time()-begin_time

print('[export Video]: Export time elapsed : '+time.strftime("%H:%M:%S", time.gmtime(used_time)))
print('[export Video]: Mean frames rendered per second : '+'%.2f'%(break_point.max()/used_time)+' FPS')
print('[export Video]: Encoding finished! Video path :',args.OutputPath+'/'+stdin_name+'.mp4')

sys.exit(0)
